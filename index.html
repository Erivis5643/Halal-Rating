<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Halal Rating</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />

    <!-- PWA: Manifest & Theme -->
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#111111" />
    <meta name="application-name" content="Halal Rating" />

    <!-- Icons: Favicon and Apple Touch -->
    <link rel="icon" type="image/png" sizes="192x192" href="/fotos/logo.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/fotos/logo.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/fotos/logo.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="/fotos/logo.png" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Halal Rating" />
  </head>
  <body>
    <!-- Image preview modal -->
    <div id="preview-modal" class="modal hidden">
      <div class="modal-content">
        <img id="preview-image" style="max-width:100%;max-height:70vh;border-radius:12px"/>
        <div class="row right top"><button id="preview-close" class="secondary">Schlie√üen</button></div>
      </div>
    </div>
    <div id="app">
      <!-- Auth Modal -->
      <div id="auth-modal" class="modal hidden">
        <div class="modal-content">
          <h2>LogIn / Register</h2>
          <label for="auth-email">E-Mail</label>
          <input id="auth-email" type="email" placeholder="you@example.com" />
          <label for="auth-password">Passwort</label>
          <input id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <div class="row">
            <button id="auth-login">Einloggen</button>
            <button id="auth-register" class="secondary">Registrieren</button>
          </div>
          <p class="hint">Du brauchst ein Konto, um die App zu nutzen.</p>
          <div class="row top">
            <button id="force-clear-cache" class="secondary" style="font-size: 12px;">Force Clear Cache</button>
          </div>
        </div>
      </div>

      <!-- Admin Action Modal (+) -->
      <div id="admin-modal" class="modal hidden">
        <div class="modal-content">
          <h2>Admin Aktionen</h2>
          <div class="column gap">
            <details>
              <summary>Passiertes Ereignis erstellen</summary>
              <div class="column gap top">
                <input id="past-name" placeholder="Name vom Ereignis" />
                <input id="past-trophies" type="number" min="0" placeholder="Anzahl Troph√§en" />
                <div class="chips" id="past-users-chips"></div>
                <div class="row gap">
                  <button id="btn-select-past-users">Teilnehmer ausw√§hlen</button>
                  <input id="past-photos-files" type="file" accept="image/*" multiple />
                </div>
                <button id="btn-create-past">Erstellen</button>
              </div>
            </details>
            <details>
              <summary>Zuk√ºnftiges Ereignis erstellen</summary>
              <div class="column gap top">
                <input id="future-name" placeholder="Event-Name" />
                <input id="future-desc" placeholder="Beschreibung" />
                <input id="future-date" type="date" />
                <input id="future-trophies" type="number" min="0" placeholder="Troph√§en (falls zutreffend)" />
                <button id="btn-create-future">Erstellen</button>
              </div>
            </details>
            <details>
              <summary>Auszeichnung geben</summary>
              <div class="column gap top">
                <div class="chips" id="award-users-chips"></div>
                <button id="btn-select-award-users">Empf√§nger ausw√§hlen</button>
                <label for="award-text">Text (erscheint beim Empf√§nger)</label>
                <input id="award-text" placeholder="Begr√ºndung / Beschreibung..." />
                <label for="award-level">Stufe</label>
                <select id="award-level">
                  <option value="bronze">ü•â Bronze (25)</option>
                  <option value="silver">ü•à Silber (50)</option>
                  <option value="gold">ü•á Gold (75)</option>
                </select>
                <button id="btn-give-award">Geben</button>
              </div>
            </details>
          </div>
          <div class="row right">
            <button id="admin-close" class="secondary">Schlie√üen</button>
          </div>
        </div>
      </div>

      <!-- Participant Selector Modal -->
      <div id="participant-modal" class="modal hidden">
        <div class="modal-content">
          <h2>Teilnehmer ausw√§hlen</h2>
          <input id="participant-search" placeholder="Benutzername suchen..." />
          <div id="participant-results" class="list" style="max-height:40vh;overflow:auto"></div>
          <div class="row right top">
            <button id="participant-cancel" class="secondary">Abbrechen</button>
            <button id="participant-confirm">√úbernehmen</button>
          </div>
        </div>
      </div>

      <!-- Main Screens -->
      <main id="screens">
        <section id="home" class="screen active">
          <div class="row space">
            <h1>Home</h1>
            <button class="nav-btn round" data-target="profile" aria-label="Profil">
              <svg viewBox="0 0 24 24"><path d="M12 12c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z"/></svg>
            </button>
          </div>
          <div id="rank-card" class="card">
            <div class="row space">
              <div>
                <div class="rank-emblem-wrap"><img id="rank-emblem" class="rank-emblem" alt="Rank Emblem"/></div>
                <div class="rank-name"><span id="rank-name">Unrankt</span></div>
                <div class="trophies">Troph√§en: <span id="trophy-count">0</span></div>
              </div>
            </div>
            <div class="progress">
              <div id="rank-progress" class="progress-bar" style="width: 0%"></div>
              <div class="progress-meta"><div id="rank-remaining" class="small"></div><div id="rank-percent" class="small muted"></div></div>
            </div>
          </div>

          <h2>Auszeichnungen</h2>
          <div id="awards-list" class="list"></div>

          <h2>Ereignisse (bekommen Troph√§en)</h2>
          <div id="user-events-list" class="list"></div>
        </section>

        <section id="leaderboard" class="screen">
          <h1>Leaderboard</h1>
          <div id="leaderboard-list" class="list"></div>
        </section>

        <section id="search" class="screen">
          <h1>Suchen</h1>
          <input id="search-input" type="text" placeholder="Benutzername suchen..." />
          <div id="search-results" class="list"></div>
        </section>

        <section id="events" class="screen">
          <div class="row space">
            <h1>Ereignisse</h1>
            <div class="row tab-bar">
              <button id="btn-tab-quests" class="tab-btn active">Quests</button>
              <button id="btn-tab-future" class="tab-btn">Zuk√ºnftige Ereignisse</button>
            </div>
          </div>
          <div id="quests-list" class="list"></div>
          <div id="quests-info" class="card top">
            <ul>
              <li>Quests aktualisieren sich t√§glich zuf√§llig nach 00:00 Uhr.</li>
              <li>Nach Questabschluss: WhatsApp-Nachricht senden</li>
              <li>Ohne Foto, Video oder Zeugenbest√§tigung keine "garantierte" Anerkennung</li>
              <li>Troph√§enzahl = Minimum, Bonus m√∂glich</li>
              <li>Whatsapp: <a href="https://chat.whatsapp.com/BtQB0wz9OcJ3UzjZmqfgmj" target="_blank" rel="noopener">Gruppe √∂ffnen</a></li>
            </ul>
          </div>
          <div id="future-events-list" class="list hidden"></div>
        </section>

        <section id="profile" class="screen">
          <h1>Profil</h1>
          <div class="profile-header">
            <img id="profile-avatar" class="avatar" alt="Avatar" />
            <div>
              <div class="username" id="profile-username">@username</div>
              <div class="profile-actions">
                <button id="btn-change-username">Benutzername wechseln</button>
                <button id="btn-upload-avatar">Profilfoto hochladen</button>
                <button id="btn-theme-toggle" class="secondary">Theme (auto)</button>
                <input id="avatar-file" type="file" accept="image/*" class="hidden" />
              </div>
            </div>
          </div>
          <div class="row gap top">
            <button id="btn-logout" class="danger">Ausloggen</button>
          </div>
        </section>

        <section id="public-profile" class="screen">
          <button id="btn-public-back" class="secondary">‚Üê Zur√ºck</button>
          <h1>Profil</h1>
          <div class="profile-header">
            <img id="public-avatar" class="avatar" alt="Avatar" />
            <div>
              <div class="username" id="public-username">@username</div>
              <div class="rank-emblem-wrap"><img id="public-rank-emblem" class="rank-emblem" alt="Rank Emblem"/></div>
              <div class="rank-name"><span id="public-rank-name">Unrankt</span></div>
              <div>Troph√§en: <span id="public-trophy-count">0</span></div>
              <div class="progress"><div id="public-rank-progress" class="progress-bar" style="width:0%"></div><div class="progress-meta"><div id="public-rank-remaining" class="small"></div><div id="public-rank-percent" class="small muted"></div></div></div>
            </div>
          </div>
          <h2>Auszeichnungen</h2>
          <div id="public-awards" class="list"></div>
          <h2>Ereignisse</h2>
          <div id="public-events" class="list"></div>
        </section>
      </main>

      <!-- Bottom Navigation -->
      <nav class="bottom-nav">
        <button id="admin-fab" class="fab hidden">Ôºã</button>
        <button class="nav-btn" data-target="home" data-default aria-label="Home">
          <svg viewBox="0 0 24 24"><path d="M12 3l8 8h-3v8h-10v-8h-3z"/></svg>
        </button>
        <button class="nav-btn" data-target="leaderboard" aria-label="Leaderboard">
          <svg viewBox="0 0 24 24"><path d="M7 17h3v-7h-3v7zm7 0h3v-12h-3v12zm-10 0h3v-4h-3v4zm14 0h3v-9h-3v9z"/></svg>
        </button>
        <button class="nav-btn" data-target="search" aria-label="Suchen">
          <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 111.06-1.06l.27.28v.79l5 4.99-1.49 1.49-4.99-5zM10 15a5 5 0 100-10 5 5 0 000 10z"/></svg>
        </button>
        <button class="nav-btn" data-target="events" aria-label="Ereignisse">
          <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>
        </button>
      </nav>
    </div>

    <!-- Config with your Supabase keys (create config.js from config.example.js) -->
    <script src="./config.js"></script>
    <!-- Supabase JS (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <!-- Register Service Worker -->
    <script>
      // Temporarily disabled to test auth issues
      /*
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
              console.log('SW registered successfully:', registration.scope);
              
              // Check for updates
              registration.addEventListener('updatefound', () => {
                console.log('SW update found');
              });
            })
            .catch(function(e) {
              console.warn('SW registration failed:', e);
            });
        });
      }
      */
      
      // Force clear cache function
      document.getElementById('force-clear-cache').addEventListener('click', async function() {
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map(name => caches.delete(name)));
          console.log('All caches cleared');
        }
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (let registration of registrations) {
            await registration.unregister();
            console.log('SW unregistered');
          }
        }
        localStorage.clear();
        sessionStorage.clear();
        location.reload();
      });
    </script>

    <script src="./app.js"></script>
  </body>
  </html>


